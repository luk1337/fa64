#!/bin/sh
### FDE.AI v4 | FeraVolt. 2019 ###
. /fde.ai/s/libfde.so;
if [ -e /sys/module/mmc_core/parameters/crc ];then echo "0">/sys/module/mmc_core/parameters/removable;echo "N">/sys/module/mmc_core/parameters/removable;echo "0">/sys/module/mmc_core/parameters/crc;echo "N">/sys/module/mmc_core/parameters/crc;echo "0">/sys/module/mmc_core/parameters/use_spi_crc;echo "N">/sys/module/mmc_core/parameters/use_spi_crc;if [ -n "$RUS" ];then flog "- Оптимизация MMC памяти";else flog "- MMC NAND memory optimization";fi;fi;if [ -d /sys/block/sda ];then OSCH="/sys/block/sda/queue/scheduler";fi;if [ -d /sys/block/dm-0 ];then OSCH="/sys/block/dm-0/queue/scheduler";fi;if [ -d /sys/block/mmcblk0 ];then OSCH="/sys/block/mmcblk0/queue/scheduler";fi;if $B grep "anxiety" $OSCH>/dev/null 2>&1;then SCHD="anxiety";elif $B grep "maple" $OSCH>/dev/null 2>&1;then SCHD="maple";elif $B grep "tripndroid" $OSCH>/dev/null 2>&1;then SCHD="tripndroid";elif $B grep "zen" $OSCH>/dev/null 2>&1;then SCHD="zen";elif $B grep "row" $OSCH>/dev/null 2>&1;then SCHD="row";elif $B grep "sioplus" $OSCH>/dev/null 2>&1;then SCHD="sioplus";elif $B grep "sio" $OSCH>/dev/null 2>&1;then SCHD="sio";elif $B grep "cfq" $OSCH>/dev/null 2>&1;then SCHD="cfq";elif $B grep "deadline" $OSCH>/dev/null 2>&1;then SCHD="deadline";else SCHD="cfq";fi;if [ -n "$RUS" ];then flog "- Планировщик встроенной памяти - $SCHD";else flog "- I/O scheduler - $SCHD";fi;if [ "$R" -ge "3600" ];then KBB=2048;BL=64;else KBB=512;BL=32;fi;for ma in /sys/devices/virtual/bdi/179*;do $B echo "$KBB">"${ma}"/read_ahead_kb;done;if [ -d /sys/block/sda ];then for sd in a b c d e f;do $B echo "$KBB">/sys/block/sd${sd}/queue/read_ahead_kb;$B echo "$SCHD">/sys/block/sd${sd}/queue/scheduler;done;fi;if [ -d /sys/block/mmcblk0 ];then $B echo "$KBB">/sys/block/mmcblk0/queue/read_ahead_kb;$B echo "$SCHD">/sys/block/mmcblk0/queue/scheduler;fi;if [ -d /sys/block/dm-0 ];then for dm in 0 1 2 3 4;do $B echo "$KBB">/sys/block/dm-${dm}/queue/read_ahead_kb;$B echo "$SCHD">/sys/block/dm-${dm}/queue/scheduler;done;fi;if [ -d /sys/class/scsi_disk ];then for iii in /sys/class/scsi_disk/*;do $B echo "write through">"${iii}"/cache_type;done;fi;if [ -n "$RUS" ];then flog "- Оптимизация скорости чтения/записи для всех разделов";else flog "- R/W speed optimization for all partitions";fi;for g in /sys/block/*/queue;do $B echo "0">"${g}"/add_random;$B echo "0">"${g}"/iostats;$B echo "2">"${g}"/nomerges;$B echo "0">"${g}"/rotational;$B echo "1">"${g}"/rq_affinity;$B echo "0">"${g}"/iosched/slice_idle;$B echo "0">"${g}"/iosched/low_latency;done;if [ -n "$RUS" ];then flog "- Оптимизация операций ввода-вывода для всех разделов";else flog "- I/O optimization for all partitions";fi;tune2fs -O "^has_journal" /dev/block/by-name/cust;tune2fs -O "^has_journal" /dev/block/by-name/cache;tune2fs -O "^has_journal" /dev/block/by-name/product;tune2fs -O "^has_journal" /dev/block/by-name/preload;tune2fs -O "^has_journal" /dev/block/by-name/data;tune2fs -O "^has_journal" /dev/block/by-name/userdata;for h in /sys/fs/ext4/*;do $B echo "$BL">"${h}"/inode_readahead_blks;done;for fg in /sys/fs/f2fs*/*;do $B echo "27">"${fg}"/ram_thresh;$B echo "48">"${fg}"/trim_sections;$B echo "300">"${fg}"/cp_interval;done;if [ -n "$RUS" ];then flog "- Оптимизация файловых систем на всех разделах";else flog "- File system optimization for all partitions";fi;exit;
