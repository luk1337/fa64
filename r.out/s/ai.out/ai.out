#!/bin/sh
### FDE.AI v4 | FeraVolt. 2019 ###
. /fde.ai/s/libfde.so;
$B sleep 27;if [ -n "$RUS" ];then flog "~ ИИ: Запуск модулей..";ftoast "ИИ: Запуск модулей..";else flog "~ AI: Initializing modules..";ftoast "AI: Initializing modules..";fi;$B setsid /fde.ai/s/aii.so &
aiiso=$($B pidof aii.so);$B renice 1 "$aiiso";$B sleep 3;if [ -e /data/ai.dat ];then state=$($B cat /data/ai.dat);fi;if [ -z "$state" ];then state="125";fi;$B touch /fde.ai/s/ai.dat;$B chmod 666 /fde.ai/s/ai.dat;$B echo "$state">/fde.ai/s/ai.dat;if [ -e /sys/devices/system/cpu/cpu9/cpufreq/cpuinfo_max_freq ];then MAXFR=$($B cat /sys/devices/system/cpu/cpu9/cpufreq/cpuinfo_max_freq);elif [ -e /sys/devices/system/cpu/cpu7/cpufreq/cpuinfo_max_freq ];then MAXFR=$($B cat /sys/devices/system/cpu/cpu7/cpufreq/cpuinfo_max_freq);elif [ -e /sys/devices/system/cpu/cpu3/cpufreq/cpuinfo_max_freq ];then MAXFR=$($B cat /sys/devices/system/cpu/cpu3/cpufreq/cpuinfo_max_freq);elif [ -e /sys/devices/system/cpu/cpu1/cpufreq/cpuinfo_max_freq ];then MAXFR=$($B cat /sys/devices/system/cpu/cpu1/cpufreq/cpuinfo_max_freq);elif [ -e /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq ];then MAXFR=$($B cat /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq);elif [ -e /sys/devices/system/cpu/cpufreq/cpuinfo_max_freq ];then MAXFR=$($B cat /sys/devices/system/cpu/cpufreq/cpuinfo_max_freq);fi;if [ "$MAXFR" -ge "2" ];then CPUVAL=$((MAXFR/100000));else CPUVAL="18";fi;if [ "$S" -ge "24" ];then getscreen(){ GETSCR=$(dumpsys deviceidle get screen);if [ "$GETSCR" = "true" ];then SCRON="1";elif [ "$GETSCR" = "false" ];then SCRON="0";fi;};elif [ "$S" -ge "19" ];then getscreen(){ GETSCR=$(dumpsys power|$B grep state=O|$B cut -d "=" -f 2);if [ "$GETSCR" = "ON" ];then SCRON="1";elif [ "$GETSCR" = "OFF" ];then SCRON="0";fi;};elif [ "$S" -le "18" ];then getscreen(){ GETSCR=$(dumpsys power|$B grep -o mScreenOn=true);if [ -n "$ON" ];then SCRON="1";else SCRON="0";fi;};fi;learnrate="1";weightp="10";weightb="5";AITUNEDP="0";AITUNEDB="0";NOGPUTURBO="0";EARLYTURBO="0";ALLOW="1";ODWC=$($B cat /proc/sys/vm/dirty_writeback_centisecs);TOT=$($B free -m|$B awk '{ print $2 }'|$B sed -n 4p);ffree(){ $B echo "3">/proc/sys/vm/drop_caches;$B echo "1">/proc/sys/vm/drop_caches;};MODEL=$(getprop ro.product.model);if [ "$MODEL" = "G8341" ];then KVER=$($B uname -r|$B grep -o "perf");if [ -n "$KVER" ];then NOGPUTURBO="1";fi;fi;KERN=$($B uname -r|$B grep -o "672816-gf39e01820045-dirty");if [ "$KERN" = "672816-gf39e01820045-dirty" ];then EARLYTURBO="1";else EARLYTURBO="0";fi;if [ -e /sys/class/kgsl/kgsl-3d0/gpubusy ];then if [ "$NOGPUTURBO" = "1" ];then GPUA=0;TGPU=0;GPUSUP=0;else GPUA=1;TGPU=0;GPUSUP=1;DGPU=$($B cat /sys/class/kgsl/kgsl-3d0/default_pwrlevel);if [ -n "$RUS" ];then flog "~ ИИ: Поддерживается FDE.AI GPUturbo";else flog "~ AI: FDE.AI GPUturbo is supported";fi;setpwrlvl(){ $B echo "$1">/sys/class/kgsl/kgsl-3d0/min_pwrlevel;$B echo "$1">/sys/class/kgsl/kgsl-3d0/default_pwrlevel;};if [ -e /sys/class/kgsl/kgsl-3d0/devfreq/adrenoboost ];then ABST=1;else ABST=0;fi;if [ -e /sys/class/kgsl/kgsl-3d0/thermal_pwrlevel ];then ATHROTTLES=1;fi;adrenothrottle(){ if [ "$ATHROTTLES" = "1" ];then ORIGTLVL=$($B cat /sys/class/kgsl/kgsl-3d0/thermal_pwrlevel);if [ "$ORIGTLVL" -ge "1" ];then CALCTHERMAL=$((ORIGTLVL-1));$B echo "$CALCTHERMAL">/sys/class/kgsl/kgsl-3d0/thermal_pwrlevel;fi;fi;};aboost(){ if [ "$ABST" = "1" ];then $B echo "$1">/sys/class/kgsl/kgsl-3d0/devfreq/adrenoboost;fi;};fi;elif [ -e /d/mali/utilization_pp ];then if [ -e /d/mali/power/always_on ];then if [ -n "$RUS" ];then flog "~ ИИ: Поддерживается FDE.AI GPUturbo";else flog "~ AI: FDE.AI GPUturbo is supported";fi;GPUM=1;TGPU=0;GPUSUP=1;maliutil="/d/mali/utilization_pp";malipower="/d/mali/power/always_on";malion="1";malioff="0";fi;elif [ -e /d/mali0/utilization_pp ];then if [ -e /d/mali0/power/always_on ];then if [ -n "$RUS" ];then flog "~ ИИ: Поддерживается FDE.AI GPUturbo";else flog "~ AI: FDE.AI GPUturbo is supported";fi;GPUM=1;TGPU=0;GPUSUP=1;maliutil="/d/mali0/utilization_pp";malipower="/d/mali0/power/always_on";malion="1";malioff="0";fi;elif [ -e /sys/class/misc/mali0/device/power_policy ];then if [ -e /sys/class/misc/mali0/device/utilization ];then if [ -n "$RUS" ];then flog "~ ИИ: Поддерживается FDE.AI GPUturbo";else flog "~ AI: FDE.AI GPUturbo is supported";fi;GPUM=1;TGPU=0;GPUSUP=1;maliutil="/sys/class/misc/mali0/device/utilization";malipower="/sys/class/misc/mali0/device/power_policy";malion="always_on";malioff="coarse_demand";elif [ -e /sys/class/misc/mali0/device/devfreq/gpufreq/gpu_scene_aware/utilisation ];then if [ -n "$RUS" ];then flog "~ ИИ: Поддерживается FDE.AI GPUturbo";else flog "~ AI: FDE.AI GPUturbo is supported";fi;GPUM=1;TGPU=0;GPUSUP=1;maliutil="/sys/class/misc/mali0/device/devfreq/gpufreq/gpu_scene_aware/utilisation";malipower="/sys/class/misc/mali0/device/power_policy";malion="always_on";malioff="coarse_demand";fi;else TGPU=0;GPUM=0;GPUA=0;GPUSUP=0;fi;if [ "$GPUM" = "1" ];then mthrottle(){ if [ -e /proc/gpufreq/gpufreq_limited_thermal_ignore ];then $B echo "$1">/proc/gpufreq/gpufreq_limited_thermal_ignore;fi;};fi;if [ -e /sys/devices/system/cpu/cpufreq/scaling_governor ];then GOV=$($B cat /sys/devices/system/cpu/cpufreq/scaling_governor);elif [ -e /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor ];then GOV=$($B cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor);fi;if [ -e /sys/devices/system/cpu/cpufreq/"$GOV"/boost ];then if [ -n "$RUS" ];then flog "~ ИИ: Поддерживается FDE.AI CPUturbo";else flog "~ AI: FDE.AI CPUturbo is supported";fi;CPUT=1;EAST=0;TCPU=0;ONDEMANDT=0;CTP="/sys/devices/system/cpu/cpufreq/$GOV/boost";TRR="/sys/devices/system/cpu/cpufreq/$GOV/timer_rate";OTR=$($B cat "$TRR");elif [ -e /sys/devices/system/cpu/cpu0/cpufreq/"$GOV"/boost ];then if [ -n "$RUS" ];then flog "~ ИИ: Поддерживается FDE.AI CPUturbo";else flog "~ AI: FDE.AI CPUturbo is supported";fi;CPUT=1;EAST=0;TCPU=0;ONDEMANDT=0;CTP="/sys/devices/system/cpu/cpu0/cpufreq/$GOV/boost";TRR="/sys/devices/system/cpu/cpu0/cpufreq/$GOV/timer_rate";OTR=$($B cat "$TRR");elif [ -e /sys/devices/system/cpu/cpufreq/"$GOV"/up_rate_limit_us ];then if [ -e /dev/stune/top-app/schedtune.boost ];then CPUT=1;EAST=1;TCPU=0;ONDEMANDT=0;EASBST="/dev/stune/top-app/schedtune.boost";OEASBST=$($B cat "$EASBST");if [ -n "$RUS" ];then flog "~ ИИ: Поддерживается FDE.AI CPUturbo";else flog "~ AI: FDE.AI CPUturbo is supported";fi;fi;elif [ -e /sys/devices/system/cpu/cpu0/cpufreq/"$GOV"/up_rate_limit_us ];then if [ -e /dev/stune/top-app/schedtune.boost ];then CPUT=1;EAST=1;TCPU=0;ONDEMANDT=0;EASBST="/dev/stune/top-app/schedtune.boost";OEASBST=$($B cat "$EASBST");if [ -n "$RUS" ];then flog "~ ИИ: Поддерживается FDE.AI CPUturbo";else flog "~ AI: FDE.AI CPUturbo is supported";fi;fi;elif [ "$GOV" = "schedutil" ];then if [ -e /dev/stune/top-app/schedtune.boost ];then CPUT=1;EAST=1;TCPU=0;ONDEMANDT=0;EASBST="/dev/stune/top-app/schedtune.boost";OEASBST=$($B cat "$EASBST");if [ -n "$RUS" ];then flog "~ ИИ: Поддерживается FDE.AI CPUturbo";else flog "~ AI: FDE.AI CPUturbo is supported";fi;fi;elif [ "$GOV" = "schedplus" ];then if [ -e /dev/stune/top-app/schedtune.boost ];then CPUT=1;EAST=1;TCPU=0;ONDEMANDT=0;EASBST="/dev/stune/top-app/schedtune.boost";OEASBST=$($B cat "$EASBST");if [ -n "$RUS" ];then flog "~ ИИ: Поддерживается FDE.AI CPUturbo";else flog "~ AI: FDE.AI CPUturbo is supported";fi;fi;elif [ -e /sys/devices/system/cpu/cpu0/cpufreq/"$GOV"/sampling_down_factor ];then if [ -n "$RUS" ];then flog "~ ИИ: Поддерживается FDE.AI CPUturbo";else flog "~ AI: FDE.AI CPUturbo is supported";fi;CPUT=1;EAST=0;TCPU=0;ONDEMANDT=1;SDF="/sys/devices/system/cpu/cpu0/cpufreq/$GOV/sampling_down_factor";elif [ -e /sys/devices/system/cpu/cpufreq/"$GOV"/sampling_down_factor ];then if [ -n "$RUS" ];then flog "~ ИИ: Поддерживается FDE.AI CPUturbo";else flog "~ AI: FDE.AI CPUturbo is supported";fi;CPUT=1;EAST=0;TCPU=0;ONDEMANDT=1;SDF="/sys/devices/system/cpu/cpufreq/$GOV/sampling_down_factor";else CPUT=0;fi;airam(){ if [ "$R" -le "2048" ];then FR=$($B free -k|$B awk '{ print $4 }'|$B sed -n 2p);if [ "$FR" -lt "$RF" ];then if [ -n "$RUS" ];then flog "~ ИИ: ОЗУ заполнена, очищаю кэш ОЗУ..";ftoast "ИИ: ОЗУ заполнена, очищаю кэш ОЗУ..";else flog "~ AI: RAM is full, freeing up RAM cache..";ftoast "AI: RAM is full, freeing up RAM cache..";fi;ffree;fi;if [ "$TOT" -ge "48" ];then ZFRE=$($B free -k|$B awk '{ print $4 }'|$B sed -n 4p);if [ "$ZFRE" -le "3" ];then if [ -n "$RUS" ];then flog "~ ИИ: zRAM переполнен - решаю проблему..";ftoast "ИИ: zRAM переполнен - решаю проблему..";else flog "~ AI: zRAM overdose detected, dealing..";ftoast "AI: zRAM overdose detected, dealing..";fi;$B echo "0">/proc/sys/vm/swappiness;$B echo "0">/sys/fs/cgroup/memory/sw/memory.swappiness;$B sysctl -e -w vm.swappiness=0;setprop sys.vm.swappiness 0;sync;$B sleep 1;ffree;$B echo "1">/proc/sys/vm/swappiness;$B echo "1">/sys/fs/cgroup/memory/sw/memory.swappiness;$B sysctl -e -w vm.swappiness=1;setprop sys.vm.swappiness 1;fi;fi;fi;};ftune(){ if [ -e /sys/kernel/sched/arch_power ];then $B echo "$1">/sys/kernel/sched/arch_power;fi;if [ -e /sys/module/workqueue/parameters/power_efficient ];then setval "$2" /sys/module/workqueue/parameters/power_efficient;fi;if [ -e /sys/module/adreno_idler/parameters/adreno_idler_active ];then $B echo "$3">/sys/module/adreno_idler/parameters/adreno_idler_active;fi;if [ "$4" = "0" ];then $B echo "600">/proc/sys/vm/dirty_writeback_centisecs;$B echo "0">/proc/sys/vm/laptop_mode;elif [ "$4" = "1" ];then $B echo "$ODWC">/proc/sys/vm/dirty_writeback_centisecs;$B echo "1">/proc/sys/vm/laptop_mode;fi;};aigpuneuron(){ if [ "$GPUSUP" = "1" ];then CHSTATE=$(dumpsys deviceidle get charging);if [ "$CHSTATE" = "true" ];then state=$((state + weightp*learnrate));if [ "$state" -ge "250" ];then state="250";fi;elif [ "$GP" -ge "75" ];then state=$((state + weightp*learnrate));if [ "$state" -ge "250" ];then state="250";fi;else $B sleep 0.1;if [ "$AITUNEDP" = "1" ];then weightb="10";else weightb="5";fi;state=$((state - weightb*learnrate));if [ "$state" -le "2" ];then state="0";fi;fi;if [ "$state" -ge "250" ];then if [ "$AITUNEDP" = "0" ];then if [ -n "$RUS" ];then flog "~ ИИ: Настраиваю систему для лучшей производительности..";else flog "~ AI: Configuring system for better performance..";fi;ftune "0" "N" "N" "0";AITUNEDP="1";AITUNEDB="0";fi;elif [ "$state" -eq "0" ];then if [ "$AITUNEDB" = "0" ];then if [ -n "$RUS" ];then flog "~ ИИ: Настраиваю систему для лучшего энергосбережения..";else flog "~ AI: Configuring system for better power-saving..";fi;ftune "1" "Y" "Y" "1";AITUNEDP="0";AITUNEDB="1";fi;fi;$B echo "$state">/fde.ai/s/ai.dat;fi;};adrenoturbo(){ GP=$($B cat /sys/class/kgsl/kgsl-3d0/gpubusy|$B awk '{print($1 /($2+1))* 100}'|$B cut -d "." -f 1);if [ "$EARLYTURBO" = "1" ];then PPP="45";else PPP=$((59+BTMP-CPUVAL));if [ "$PPP" -lt "75" ];then PPP=75;elif [ "$PPP" -gt "85" ];then PPP=85;fi;fi;if [ "$GP" -ge "$PPP" ];then if [ "$TGPU" = "0" ];then if [ "$BTMP" -ge "42" ];then setpwrlvl "1";aboost "1";$B echo "0">/sys/class/kgsl/kgsl-3d0/popp;TGPU=1;if [ -n "$RUS" ];then flog "~ ИИ: Режим GPUturbo активирован";else flog "~ AI: GPUturbo mode activated";fi;else setpwrlvl "0";aboost "3";$B echo "0">/sys/class/kgsl/kgsl-3d0/popp;TGPU=1;if [ -n "$RUS" ];then flog "~ ИИ: Режим GPUturbo активирован";else flog "~ AI: GPUturbo mode activated";fi;fi;fi;else setpwrlvl "$DGPU";aboost "0";$B echo "1">/sys/class/kgsl/kgsl-3d0/popp;TGPU=0;fi;};maliturbo(){ GP=$($B cat $maliutil);PPP=$((59+BTMP-CPUVAL));if [ "$PPP" -lt "75" ];then PPP=75;elif [ "$PPP" -gt "85" ];then PPP=85;fi;if [ "$GP" -ge "$PPP" ];then if [ "$TGPU" = "0" ];then TGPU=1;if [ "$BTMP" -ge "42" ];then mthrottle "0";else mthrottle "1";fi;$B echo "$malion">$malipower;if [ -n "$RUS" ];then flog "~ ИИ: Режим GPUturbo активирован";else flog "~ AI: GPUturbo mode activated";fi;fi;else $B echo "$malioff">$malipower;mthrottle "0";TGPU=0;fi;};cputurbo(){ CLOAD=$($B top -n 1 -d 1|$B grep "CPU:"|$B cut -d ":" -f 2|$B cut -d "." -f 1|$B sed 's/ //g');CCL=$((BTMP*2-BTMP/3-CPUVAL));if [ "$CCL" -lt "39" ];then CCL=39;fi;if [ "$CLOAD" -ge "$CCL" ];then if [ "$TCPU" = "0" ];then if [ -n "$RUS" ];then flog "~ ИИ: Режим CPUturbo активирован";else flog "~ AI: CPUturbo mode activated";fi;TCPU=1;if [ "$EAST" = "1" ];then $B echo "25">"$EASBST";elif [ "$ONDEMANDT" = "1" ];then $B echo "9">"$SDF";else $B echo "1">"$CTP";$B echo "15000">"$TRR";fi;fi;else TCPU=0;if [ "$EAST" = "1" ];then $B echo "$OEASBST">"$EASBST";elif [ "$ONDEMANDT" = "1" ];then $B echo "2">"$SDF";else $B echo "0">"$CTP";$B echo "$OTR">"$TRR";fi;fi;};turboallowed(){ GETPROC=$($B top -n 1 -d 1|$B head -7|$B grep -o -e "whatsapp" -e "telegram" -e "instagram" -e "youtube" -e "player" -e "facebook" -e "gallery" -e "music" -e "video");if [ -n "$GETPROC" ];then ALLOW="0";else ALLOW="1";fi;};if [ -e /d/mdp/perf/perf_mode ];then FBTURBO="0";FBTSUP="1";fbturbo(){ $B echo "$1">/d/mdp/perf/perf_mode;FBTURBO="$1";};else FBTSUP="0";fi;while true;do getscreen;if [ "$SCRON" = "1" ];then airam;turboallowed;BTMP=$(dumpsys battery|$B grep "temperature"|$B awk '{ print $2 }'|$B head -1|$B cut -c 1-2);if [ -z "$BTMP" ];then BTMP=30;fi;if [ "$ALLOW" = "1" ];then if [ "$FBTSUP" = "1" ];then if [ "$FBTURBO" = "0" ];then fbturbo "1";fi;fi;if [ "$CPUT" = "1" ];then cputurbo;fi;if [ "$GPUA" = "1" ];then adrenoturbo;adrenothrottle;elif [ "$GPUM" = "1" ];then maliturbo;fi;elif [ "$ALLOW" = "0" ];then if [ "$FBTURBO" = "1" ];then fbturbo "0";fi;if [ "$TCPU" = "1" ];then if [ "$EAST" = "1" ];then $B echo "$OEASBST">"$EASBST";elif [ "$ONDEMANDT" = "1" ];then $B echo "2">"$SDF";else $B echo "0">"$CTP";$B echo "$OTR">"$TRR";fi;fi;if [ "$TGPU" = "1" ];then if [ "$GPUA" = "1" ];then aboost "0";setpwrlvl "$DGPU";$B echo "1">/sys/class/kgsl/kgsl-3d0/popp;elif [ "$GPUM" = "1" ];then $B echo "$malioff">$malipower;mthrottle "0";fi;fi;fi;aigpuneuron;if [ "$EARLYTURBO" = "1" ];then $B sleep 9;else $B sleep 27;fi;else $B sleep 0.1;if [ "$FBTURBO" = "1" ];then fbturbo "0";fi;if [ "$GPUSUP" = "1" ];then if [ "$AITUNEDB" = "0" ];then ftune "1" "Y" "Y" "1";AITUNEDP="0";AITUNEDB="1";if [ -n "$RUS" ];then flog "~ ИИ: Настраиваю систему для лучшего энергосбережения..";else flog "~ AI: Configuring system for better power-saving..";fi;fi;if [ "$TGPU" = "1" ];then if [ "$GPUA" = "1" ];then aboost "0";setpwrlvl "$DGPU";$B echo "1">/sys/class/kgsl/kgsl-3d0/popp;elif [ "$GPUM" = "1" ];then $B echo "$malioff">$malipower;mthrottle "0";fi;fi;fi;if [ "$TCPU" = "1" ];then if [ "$EAST" = "1" ];then $B echo "$OEASBST">"$EASBST";elif [ "$ONDEMANDT" = "1" ];then $B echo "2">"$SDF";else $B echo "0">"$CTP";$B echo "$OTR">"$TRR";fi;fi;$B sleep 69;fi;done;
